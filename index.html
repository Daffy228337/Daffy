<!DOCTYPE html>
<html>
<head>
    <title>Симуляция доставки</title>
    <meta charset="utf-8" />
    <script src="https://api-maps.yandex.ru/2.1/?apikey=0f2d1024-aa27-4ceb-b1cc-284236a7812d&lang=ru_RU" type="text/javascript"></script>
    <style>
        html, body, #map {
            width: 100%;
            height: 100%;
            padding: 0;
            margin: 0;
        }
        #controls {
            position: absolute;
            top: 10px;
            left: 10px;
            background-color: white;
            padding: 10px;
            border-radius: 5px;
        }
    </style>
</head>
<body>
    <div id="map"></div>
    <div id="controls">
        <button onclick="addCourier()">Добавить курьера</button>
        <button onclick="removeCourier()">Убрать курьера</button>
        <br><br>
        <button onclick="createOrder()">Создать заказ</button>
        <button onclick="assignOrder()">Назначить заказ</button>
        <br><br>
        <div>Список курьеров:</div>
        <ul id="courierList"></ul>
        <br>
        <div>Лог заказов:</div>
        <ul id="orderList"></ul>
        <br>
        <div>Лог назначений:</div>
        <ul id="assignmentLog"></ul>
    </div>
    <script>
        ymaps.ready(init);

        let myMap;
        let restaurantCoords = [48.708406, 44.514243]; // Координаты ресторана
        let couriers = [];
        let orders = [];
        let nextOrderId = 1;
        let nextCourierId = 1;
        let sectorBoundaries; 

        function init() {
            myMap = new ymaps.Map("map", {
                center: restaurantCoords,
                zoom: 14 // Уменьшил зум для лучшей видимости секторов
            });

            // Добавляем метку ресторана
            let restaurantMarker = new ymaps.Placemark(restaurantCoords, {
                balloonContent: "Ресторан"
            });
            myMap.geoObjects.add(restaurantMarker);

            // Определяем границы секторов (примерные, скорректируйте при необходимости)
            sectorBoundaries = [
                { sector: "A", color: "#FF0000", coords: [[48.728406, 44.534243], [48.688406, 44.494243], restaurantCoords] }, // СВ
                { sector: "B", color: "#00FF00", coords: [[48.688406, 44.494243], [48.688406, 44.534243], restaurantCoords] }, // СЗ
                { sector: "C", color: "#0000FF", coords: [[48.688406, 44.534243], [48.728406, 44.574243], restaurantCoords] }, // ЮЗ
                { sector: "D", color: "#FFFF00", coords: [[48.728406, 44.574243], [48.728406, 44.534243], restaurantCoords] }  // ЮВ
            ];

            // Рисуем сектора
            drawSectors();
        }

        function drawSectors() {
            sectorBoundaries.forEach(sector => {
                let polygon = new ymaps.Polygon([sector.coords], {}, {
                    fillColor: sector.color,
                    opacity: 0.3,
                    strokeWidth: 0
                });
                myMap.geoObjects.add(polygon);
            });
        }

        function addCourier() {
            couriers.push({
                id: nextCourierId++,
                orders: []
            });
            console.log(`Курьер номер ${nextCourierId - 1} добавлен`);
            updateCourierList();
        }

        function removeCourier() {
            if (couriers.length > 0) {
                couriers.pop();
                console.log(`Курьер номер ${nextCourierId - 1} удален`);
                updateCourierList();
            }
        }

        function createOrder() {
            let orderCoords = generateRandomCoords();
            let sector = getSector(orderCoords);
            let order = {
                id: nextOrderId++,
                coords: orderCoords,
                sector: sector,
                time: new Date().toLocaleString('ru-RU', { timeZone: 'Europe/Moscow' })
            };
            orders.push(order);

            let orderMarker = new ymaps.Placemark(orderCoords, {
                balloonContent: `Заказ ${order.id}`
            }, {
                preset: 'islands#redCircleIcon'
            });
            myMap.geoObjects.add(orderMarker);

            console.log(`Создан заказ ${order.id} в секторе ${sector} в ${order.time}`);
            updateOrderList();
        }

        function assignOrder() {
            if (orders.length === 0) return;

            let assignedOrder = orders.shift();
            let assignedCourier = chooseCourier(assignedOrder); // Функция выбора курьера

            if (assignedCourier) {
                assignedCourier.orders.push(assignedOrder);
                console.log(`Заказ ${assignedOrder.id} назначен курьеру ${assignedCourier.id}`);
            } else {
                // Обработка случая, когда нет доступных курьеров
                console.log("Нет доступных курьеров для заказа", assignedOrder.id);
            }

            updateOrderList();
            updateCourierList();
            updateAssignmentLog();
        }

        function chooseCourier(order) {
          // TODO: Реализовать логику выбора курьера по алгоритму из ТЗ
          return couriers[0]; // Временная заглушка - возвращает первого курьера
        }

        function generateRandomCoords() {
            let lat = restaurantCoords[0] + (Math.random() - 0.5) * 0.05; // +/- 0.05 градуса от ресторана
            let lng = restaurantCoords[1] + (Math.random() - 0.5) * 0.05;
            return [lat, lng];
        }

        function getSector(coords) {
            for (let i = 0; i < sectorBoundaries.length; i++) {
                let sector = sectorBoundaries[i];
                if (isPointInTriangle(coords, sector.coords[0], sector.coords[1], sector.coords[2])) {
                    return sector.sector;
                }
            }
            return null; // Точка не принадлежит ни одному сектору
        }

        // Функция проверки принадлежности точки треугольнику
        // (https://stackoverflow.com/questions/2049582/how-to-determine-if-a-point-is-in-a-2d-triangle)
        function isPointInTriangle(p, p0, p1, p2) {
            let a = (p1[0] - p0[0]) * (p[1] - p0[1]) - (p1[1] - p0[1]) * (p[0] - p0[0]);
            let b = (p2[0] - p1[0]) * (p[1] - p1[1]) - (p2[1] - p1[1]) * (p[0] - p1[0]);
            let c = (p0[0] - p2[0]) * (p[1] - p2[1]) - (p0[1] - p2[1]) * (p[0] - p2[0]);
            return (a >= 0 && b >= 0 && c >= 0) || (a <= 0 && b <= 0 && c <= 0);
        }

        function updateCourierList() {
            let courierList = document.getElementById("courierList");
            courierList.innerHTML = "";
            couriers.forEach((courier, index) => {
                let li = document.createElement("li");
                li.textContent = `Курьер ${courier.id}`;
                courierList.appendChild(li);
            });
        }

        function updateOrderList() {
            let orderList = document.getElementById("orderList");
            orderList.innerHTML = "";
            orders.forEach(order => {
                let li = document.createElement("li");
                li.textContent = `${order.id}Заказ Сектор ${order.sector}. ${order.time}`;
                orderList.appendChild(li);
            });
        }

        function updateAssignmentLog() {
            let assignmentLog = document.getElementById("assignmentLog");
            assignmentLog.innerHTML = "";
            couriers.forEach(courier => {
                let ordersInSectors = {};
                courier.orders.forEach(order => {
                    if (!ordersInSectors[order.sector]) {
                        ordersInSectors[order.sector] = [];
                    }
                    ordersInSectors[order.sector].push(order.id);
                });

                let li = document.createElement("li");
                li.textContent = `Курьер ${courier.id}: `;
                for (let sector in ordersInSectors) {
                    li.textContent += `Заказы (${sector}: ${ordersInSectors[sector].join(',')}) `;
                }
                assignmentLog.appendChild(li);
            });
        }
    </script>
</body>
</html>